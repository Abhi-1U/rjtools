---
title: "More details on the R Journal format"
author: H. Sherry Zhang and Di Cook
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{format-details}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo = FALSE}
library(rjtools)
```

This article will work you through the key parts of an rjournal template article as produced by `create_article()`. This assumes that you have already followed the **Create an R Journal Article** vignette, have created your initial article, and you have been able to knit both the `pdf` and `html` article. Here we explain the important parts you can see in the `Rmd` file that generates both output types, and how to modify them, and to debug if problems arise.

# YAML header

This has these components:

- `title: "your article title"`
- `abstract: > ....`
- `author:` with separate lines for `name:`, `affiliation:`, `address:`, `url:`, `orcid:`, `email:` and a block for each author
- `output:` as `rjtools::rjournal_web_article`
- `bibliography: RJreferences.bib`

# Figures

The new R Journal format supports interactive plots in the html output, on top of the conventional static plots in both pdf and html outputs. The following section will show examples on creating static and interactive plots with the R Journal format.

## Static

For a static plot, use `\@ref(fig:penguins)` for in-text reference and your code chunk should look something like this:

````markdown
`r ''````{r penguins, fig.cap="This is the figure caption"}
penguins %>% 
  ggplot(aes(x = flipper_length_mm, y = body_mass_g, 
             color = species)) + 
  geom_point()
```
````

This chunk will be evaluated for both pdf and html rendering and the html reference syntax `\@ref(fig:penguins)` works in both formats under the `rjtools::rjournal_web_article` output (which you specified in the YAML header).

## Interactive 

One of the advantages of the new R Journal format is to allow interactive graphics and animation in the html article while provide a static version in the pdf article. To do this, you will need two code chunks with conditional evaluation:

````markdown
`r ''````{r penguins-static, eval=knitr::is_latex_output(), fig.cap="This is the figure caption."}
penguins %>%
  ggplot(aes(x = bill_depth_mm, y = bill_length_mm,
             color = species)) +
  geom_point()
```
````

````markdown
`r ''````{r penguins-interactive, eval=knitr::is_html_output(), fig.cap="This is the figure caption."}
p1 <- penguins %>%
  ggplot(aes(x = bill_depth_mm, y = bill_length_mm,
             color = species)) +
  geom_point()
plotly::ggplotly(p1)
```
````

Here the `penguins-static` chunk is only evaluated in the pdf article, given `eval = knitr::is_latex_output()` and the second chunk `penguins-interactive` is only evaluated when building the html article (`eval = knitr::is_html_output()`). 

The in-text citation is a bit more complicated since it involves referencing different chunks. You will need something like this: 

    Figure `r "\u0060r"` knitr::asis_output(ifelse(knitr::is_html_output(), '\\@ref(fig:penguins-interactive)', '\\@ref(fig:penguins-static)'))`r "\u0060"` shows ...
    
The if-else statement uses `knitr::is_html_output()` to decide if the output is an html or pdf ouput. For an html output, `\\@ref(fig:penguins-interactive)` will be used to reference the chunk of the interactive graphic. If the output is a pdf, `\\@ref(fig:penguins-static)` will reference the static chunk. Finally, `knitr::asis_output()` makes sure that the reference string is parsed as it is, so no special treatment on `\@`.

## Sizing

For static plots, you can use `fig.width` and `fig.height` to adjust figure sizing for both pdf and html outputs. 

For html output, distill provides several larger than text-width layouts, i.e. `l-body-outset`, `l-page`, and `l-screen`. These can be set via the chunk option `layout`:

````rmarkdown
`r ''````{r layout = "l-body-outset", fig.width = 5, fig.height = 3}
library(ggplot2)
library(palmerpenguins)
ggplot(data = penguins, 
       aes(x = flipper_length_mm,
           y = body_mass_g, 
           color = species)) + 
  geom_point()
```
````

Notice that `fig.width` and `fig.height` still apply here and `layout` option will not affect the pdf rendering. Some interactive graphics set the figure sizing inside its function, for example, 
  
  - `plotly::ggplotly(p, width = ..., height = ...)`, and 
  - `ggiraph::girafe(p, width_svg = ..., height_svg = ...)`. 
  
Sizing these figures should via the relevant arguments rather than the chunk options.

## Alt text

Alt text is read by a screen reader for people with visual disability and authors are encouraged to include alt text in their figures to make them more accessible in the R community. You only need to add alt text for the html figures and this can be done via the `fig.alt` chunk option. There are a few guidelines on how to write an alt text can be found at [here](https://www.vic.gov.au/alternative-text), [here](https://rjionline.org/news/alt-text-is-journalism-enhancing-your-reporting-with-accessibility/), and [here](https://medium.com/nightingale/writing-alt-text-for-data-visualization-2a218ef43f81). Remember an alt text is not supposed to tell the reader what can be learnt from the plot, but merely to describe what is on the plot. With a good alt text, people should be able to sketch a copy of the figure based on your description. 

# Tables

Both markdown table and `knitr::kable()` are supported in both pdf and html articles with the R Journal format

To use a simple [markdown table](https://www.markdownguide.org/extended-syntax/#tables), you need to add `preamble: \usepackage{longtable}` in the YAML to render the pdf output. 


With `knitr::kable()` two chunks need to be set up with different `format` arguments, similar to the interactive graphics:

````rmarkdown
`r ''````{r penguins-interactive, eval = knitr::is_html_output()}
knitr::kable(head(penguins), format = "html", caption = "Table caption")
```
````

````rmarkdown
`r ''````{r penguins-static, eval = knitr::is_latex_output()}
knitr::kable(head(penguins), format = "latex", caption = "Table caption")
```   
````

For inline reference, remember to use `tab:` instead of `fig:` in `\\@ref(tab:penguins-interactive)` and `\\@ref(tab:penguins-static)`. The same `layout` used for figure sizing is also applicable for tables.

# Citations

The citation style will be added during the building process and you can find the csl file [here](https://github.com/rjournal/rjtools/blob/main/inst/rjournal.csl). This style adopts a "capitalize-first" text case on title, which means it will capitalise the first world, including the one after the colon, and use lowercase for the rest. If you would like to preserve the text case of the title in the reference, wrap the word with curly braces. A common example of this is to preserve the lowercase R package name: 

```{eval = FALSE}
@Manual{crosstalk,
  title = {{crosstalk}: Inter-Widget Interactivity for HTML Widgets},
  author = {Joe Cheng and Carson Sievert},
  year = {2021},
  note = {R package version 1.1.1},
  url = {https://CRAN.R-project.org/package=crosstalk},
}
```

R Journal requires a link for easy access to the reference and this can be done through either the `doi` or `url` field. If both fields are presented, `url` takes priority and we recommend providing the URL link as `url = {https://doi.org/.../...},`.


# Styling

Custom `css` is discouraged, because all articles should look similar. However, if you would like to make **small** changes in style for the appearance of your paper, even to get sizing of plots and tables cleaner in the html output, you can add a custom `css` and point to it in the YAML along with the `rjournal.css`. 

# Others

  - Randomisation: if your code contains any randomisation, make sure a seed is used so that the pdf and html article render the same result. 

# Converting from other Rmarkdown formats

If you are already writing your articles using Rmarkdown, and have written your article using the `rticles::rjournal_article` style it is straightforward to make the switch to the `rjtools` styling. These are the steps that you need to follow:

1. change output formats to `rjtools::rjournal_web_article` to switch to the new style, 
2. remove any latex specific functionality, 
3. change figure, table references to `\@ref()` and 
4. add the `rjournal.csl` and `rjournal.css` template files to your folder, updating YAML to utilise them, and 
5. set the reference to the `.bib` in the YAML.

# Trouble-shooting

If the pdf did not compile, check your latex installation, and update your version of `rjtools`. If this hasn't fixed the problem, there may be a latex error in your file. If the `.tex` file was created you can use latex on your system to typeset from this file, and it might help you track down the location of the error in the `.tex` file, and hence narrow down the location in the `.Rmd`.


